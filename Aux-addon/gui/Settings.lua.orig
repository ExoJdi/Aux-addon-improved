module 'aux.gui.settings'

include 'aux'

local gui = require 'aux.gui'

local frame

local function ensure_tooltip_settings()
	-- tooltip_settings is created in aux.core.slash:LOAD2().
	-- If the user opens settings very early, fall back to the saved table.
	if not _G.tooltip_settings then
		_G.tooltip_settings = character_data'tooltip'
	end
end

local function bool(v) return not not v end

local function add_check(parent, y, text, getter, setter)
	local cb = gui.checkbox(parent)
	cb:SetPoint('TOPLEFT', 14, y)
	cb:SetScript('OnClick', function()
		setter(cb:GetChecked())
	end)
	local label = gui.label(cb, gui.font_size.small)
	label:SetPoint('LEFT', cb, 'RIGHT', 6, 1)
	label:SetText(text)
	cb._refresh = function() cb:SetChecked(bool(getter())) end
	return cb
end

local function add_scale(parent, y)
	local slider = gui.slider(parent)
	slider:SetPoint('TOPLEFT', 14, y)
	slider:SetWidth(250)
	slider:SetMinMaxValues(0.50, 2.00)
	slider:SetValueStep(0.01)
	slider.label:SetText('Scale')

	local updating
	local function apply(v)
		v = tonumber(v)
		if not v then return end
		if v < 0.50 then v = 0.50 end
		if v > 2.00 then v = 2.00 end
		v = floor(v * 100 + 0.5) / 100
		_G.aux_scale = v
		if _G.AuxFrame then
			AuxFrame:SetScale(v)
		end
		updating = true
		slider.editbox:SetText(string.format('%.2f', v))
		updating = false
	end

	slider:SetScript('OnValueChanged', function()
		if updating then return end
		apply(slider:GetValue())
	end)

	slider.editbox:SetNumeric(false)
	slider.editbox:SetMaxLetters(6)
	-- Use the same "change" convention as aux.gui.slider editboxes.
	slider.editbox.change = function()
		apply(this:GetText())
		slider:SetValue(_G.aux_scale or 1)
	end

	slider._refresh = function()
		local v = _G.aux_scale or 1
		updating = true
		slider:SetValue(v)
		slider.editbox:SetText(string.format('%.2f', v))
		updating = false
	end

	return slider
end

local function build()
	ensure_tooltip_settings()

	frame = CreateFrame('Frame', 'AuxSettingsFrame', UIParent)
	gui.set_window_style(frame)
	gui.set_size(frame, 360, 390)
	frame:SetPoint('CENTER', UIParent, 'CENTER', 0, 0)
	frame:SetToplevel(true)
	frame:SetMovable(true)
	frame:EnableMouse(true)
	frame:SetClampedToScreen(true)
	frame:RegisterForDrag('LeftButton')
	frame:SetScript('OnDragStart', function() this:StartMoving() end)
	frame:SetScript('OnDragStop', function() this:StopMovingOrSizing() end)
	frame:Hide()

	local title = gui.label(frame, gui.font_size.large)
	title:SetPoint('TOPLEFT', 12, -10)
	title:SetText(color.white'Aux Options')

	local close = gui.button(frame, gui.font_size.small)
	gui.set_size(close, 60, 22)
	close:SetPoint('TOPRIGHT', -8, -8)
	close:SetText('Close')
	close:SetScript('OnClick', function() frame:Hide() end)

	local content = gui.panel(frame)
	content:SetPoint('TOPLEFT', 8, -38)
	content:SetPoint('BOTTOMRIGHT', -8, 8)

	local y = -14
	frame._widgets = {}

	-- Checkboxes (mirrors /aux toggles)
	tinsert(frame._widgets, add_check(content, y, 'Ignore owner',
		function() return _G.aux_ignore_owner end,
		function(v) _G.aux_ignore_owner = v end))
	y = y - 26

	tinsert(frame._widgets, add_check(content, y, 'Post bid',
		function() return _G.aux_post_bid end,
		function(v) _G.aux_post_bid = v end))
	y = y - 26

	gui.horizontal_line(content, y - 8)
	y = y - 22

	tinsert(frame._widgets, add_check(content, y, 'Tooltip value',
		function() return tooltip_settings.value end,
		function(v) tooltip_settings.value = v end))
	y = y - 26

	tinsert(frame._widgets, add_check(content, y, 'Tooltip historical',
		function() return tooltip_settings.historical end,
		function(v) tooltip_settings.historical = v end))
	y = y - 26

	tinsert(frame._widgets, add_check(content, y, 'Tooltip merchant buy',
		function() return tooltip_settings.merchant_buy end,
		function(v) tooltip_settings.merchant_buy = v end))
	y = y - 26

	tinsert(frame._widgets, add_check(content, y, 'Tooltip merchant sell',
		function() return tooltip_settings.merchant_sell end,
		function(v) tooltip_settings.merchant_sell = v end))
	y = y - 26

	tinsert(frame._widgets, add_check(content, y, 'Tooltip disenchant value',
		function() return tooltip_settings.disenchant_value end,
		function(v) tooltip_settings.disenchant_value = v end))
	y = y - 26

	tinsert(frame._widgets, add_check(content, y, 'Tooltip disenchant distribution',
		function() return tooltip_settings.disenchant_distribution end,
		function(v) tooltip_settings.disenchant_distribution = v end))
	y = y - 36

	gui.horizontal_line(content, y + 10)

	tinsert(frame._widgets, add_scale(content, y - 18))

	frame:SetScript('OnShow', function()
		ensure_tooltip_settings()
		for _, w in ipairs(frame._widgets) do
			if w and w._refresh then w:_refresh() end
		end
	end)
end

function toggle()
	if not frame then build() end
	if frame:IsShown() then frame:Hide() else frame:Show() end
end
